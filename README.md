# 一、简介

## 1.1 为什么需要es

 当我们想要模糊查找某些数据的时候，在关系型数据库，可以使用like '%手机%'这种方式，但是，如果我们在搜索的场景下，比如我想要买一款冬天穿的毛衣，我们会搜索：“毛衣  厚  冬天 男”，那么就会按照我们的搜索条件，查询出相关产品了，如果想要通过关系型数据库来实现，就会非常麻烦了。并且，在海量数据下，like的查询性能也不高。那么，我们怎么去解决这个问题呢？关于这个问题，我们可以通过使用Elasticsearch来实现。

## 1.2 什么是es

Elasticsearch基于Lucene的搜索服务器。

* 不是数据库，适合海量数据、更新频率很低的数据【ES没有事务，不适合处理并行更改的数据】

* 适合处理关系简单的数据，
* 使用案例
  * 维基百科使用Elasticsearch来进行全文搜索做高亮关键词，提供search-as-you-type、did-you-mean等搜索建议功能。
  * github使用使用Elasticsearch来检索超过1300亿行代码。

## 1.3 Elasticsearch和Solr

### 1.3.1 Elasticsearch优缺点

【简介】

- Elasticsearch是一个**实时的分布式**搜索和分析引擎。
- Elasticsearch是一个建立在全文搜索引擎 Apache Lucene™ 基础上的搜索引擎，可以说Lucene是当今最先进，最高效的全功能开源搜索引擎框架。但是Lucene只是一个框架，要充分利用它的功能，需要使用JAVA，并且在程序中集成Lucene。需要很多的学习了解，才能明白它是如何运行的，Lucene确实非常复杂。

- Elasticsearch使用Lucene作为内部引擎，但是在使用它做全文搜索时，只需要使用统一开发好的API即可，而不需要了解其背后复杂的Lucene的运行原理。

【优点】

- Elasticsearch是**分布式**的（天生带有易扩展高可用的特性），不需要其他组件，分发是实时的，被叫做”Push replication”。
- Elasticsearch完全支持Apache Lucene 的**接近实时的搜索**（新增到ES中的数据在1秒后就可以被检索到）。

- 处理多租户（multitenancy）不需要特殊配置，而Solr则需要更多的高级设置。
- Elasticsearch采用Gateway 的概念，使得完备份更加简单。

- 各节点组成对等的网络结构，某些节点出现故障时会自动分配其他节点代替其进行工作。

【缺点】

- **非实时性**的搜索的速度没有Solr快。
- Elasticsearch**仅支持json**文件格式。
- 版本更新太多，比如6.x和7.x在使用上也有不少的区别。

### 1.3.2 Solr的优缺点

【简介】

- Solr（读作“solar”）是Apache Lucene项目的开源企业搜索平台。其主要功能包括全文检索、命中标示、分面搜索、动态聚类、数据库集成，以及富文本（如Word、PDF）的处理。Solr是高度可扩展的，并提供了分布式搜索和索引复制。Solr是最流行的企业级搜索引擎，Solr4 还增加了NoSQL支持。
- Solr是用Java编写、运行在Servlet容器（如 Apache Tomcat 或Jetty）的一个独立的全文搜索服务器。Solr采用了 Lucene Java 搜索库为核心的全文索引和搜索，并具有类似REST的HTTP/XML和JSON的API。Solr强大的外部配置功能使得无需进行Java编码，便可对 其进行调整以适应多种类型的应用程序。Solr有一个插件架构，以支持更多的高级定制。

- 因为2010年 Apache Lucene 和 Apache Solr 项目合并，两个项目是由同一个Apache软件基金会开发团队制作实现的。提到技术或产品时，Lucene/Solr或Solr/Lucene是一样的。

【优点】

- Solr有一个更大、更成熟的用户、开发和贡献者社区。
- 支持添加**多种格式**的索引，如：HTML、PDF、微软 Office 系列软件格式以及 JSON、XML、CSV 等纯文本格式。

- Solr比较成熟、稳定。
- 不考虑建索引的同时进行搜索，速度更快。

【缺点】

- 建立索引时，搜索效率下降，**实时索引搜索效率不高**。

【总结】

  二者安装都很简单；

- Solr 利用 Zookeeper 进行分布式管理，而 Elasticsearch 自身带有分布式协调管理功能;
- Solr 支持更多格式的数据，而 Elasticsearch 仅支持json文件格式；

- Solr 官方提供的功能更多，而 Elasticsearch 本身更注重于核心功能，高级功能多有第三方插件提供；
- Solr 在传统的搜索应用中表现好于 Elasticsearch，但在处理实时搜索应用时效率明显低于 Elasticsearch。

- Solr 是传统搜索应用的有力解决方案，但 Elasticsearch 更适用于新兴的实时搜索应用。

# 二、 ES概念介绍

## 2.1 index type document field

* ES概念与关系型数据库概念对比

| RDBMS  | ES       | 描述                                                         |
| ------ | -------- | ------------------------------------------------------------ |
| table  | index    | 指向一个或多个物理分配的逻辑命名空间【7.X版本之后，type被废除，所以ES没有了数据库的说法】 |
|        | ~~type~~ | 用于区分一个集合的不同细分<br />（[8.X版本完全废弃type](https://www.elastic.co/guide/en/elasticsearch/reference/master/removal-of-types.html)） |
| row    | document | ES是面向文档的，各种文本内容以文档的形式存储到ES中。以JSON作为文档的序列号格式 |
| column | field    | 文档有很多字段，可以指定字段的数据格式                       |

- 索引

  索引是**映射类型**的容器，它是一个非常大的文档集合。索引存储了映射类型的字段和其他设置。然后他们被存储到了各个分片上。

- ~~类型~~

  ~~类型是**文档**的逻辑容器，就像关系型数据库一样，表格是行的容器。类型对于字段的定义称为映射，比如：name映射为字符串类型。~~

- 文档

  一个文档同时包含字段和对应的值，也就是同时包含key:value，ES是面向文档的，意味着索引和搜索数据的最小单位就是文档。

  文档的结构很灵活，不依赖预先定义的模式，它对于字段是非常灵活的，有时候，我们可以忽略字段或者动态的添加一个新的字段。

## 2.2 分片、副本

- 分片

  在大数据时代，单机是无法存储规模巨大的数据的。那么我们就将数据拆分成多个部分，然后存储到多台机器，构成大规模集群。那么这种数据拆分成若干个部分就叫做分片。

- 副本

  如果分片挂掉了，数据就丢失了。那么为了提高系统的可用性。我们把分片复制多个，这就是副本了。

  副本除了可以有备份的作用之外，还能够实现并行的读取操作，分担集群压力。

  但是，副本的产生，也会随之带来**数据一致性的问题**，即：有的副本写数据成功，但是有的副本写数据失败。

- ES将数据副本分为主从两部分，即：**主分片**（primary shard）和**副分片**（replica shard）

  主分片上的数据作为权威的数据。

  当写数据的时候，先写主分片，写入成功后再写副分片。

  恢复数据的时候，以主分片上的数据为准。

  当我们创建一个索引的时候，默认是5个分片，每个分片1个副本。

* 分片是底层的**基本读写单元**。ES利用分片将数据分发到集群内各处。**分片是数据的容器，文档保存在分片内，不会跨分片存储**。分片又被分配到集群内的各个节点里。当集群规模变化的时候，ES会**自动**将集群中节点上的分片进行重新的分配和迁移，从而保证数据仍然**均匀分布**在集群里。

## 2.3 什么是全文检索

### 2.3.1 数据分类

* 结构化数据：固定格式，有限长度  如mysql存储的数据
* 非结构化数据：不确定的长度，无固定格式 如邮箱，word文档，日志
* 半结构化数据：前两者的结合：如xml，html

### 2.3.2 搜索分类

* 结构化数据搜索：关系型数据库
* 非结构化数据搜索：

- 顺序扫描
- 全文检索
  设搜索场景如下：

| name       | content                                                      | author |
| ---------- | ------------------------------------------------------------ | ------ |
| 静夜思     | 床前明月光，疑似地上霜。举头望明月，低头思故乡。             |        |
| 望庐山瀑布 | 日照香炉生紫烟，遥看瀑布挂前川。飞流直下三千尺，疑是银河落九天。 |        |
| 登鹤雀楼   | 白日依山尽，黄河入海流。欲穷千里目，更上一层楼。             |        |
| ...        | ...                                                          | ...    |

思考：使用传统关系数据库和ES实现会有什么差别？
若是MYSQL存储，需要些查询的SQL：

````sql 
select name from poems where content like '%前%'
````

这种我们称为顺序扫描法，需要遍历所有的记录进行匹配。不但效率低，而且不符合我的搜索时的期望，比如：搜索“ABCD”的关键词，还希望看到“A”，“AB”，“CD”，“ABC”的搜说结果。

### 2.3.3 全文检索概念

    1. 通过一个程序扫描文本中的每一个单词，针对单词建立索引，并保存该单词在文本中的位置、以及出现的次数
    2. 用户查询时，通过建立好的索引来查询，将索引中单词对应的文本位置、出现的次数返回给用户，因为有了具体文本的位置，所以就可以将具体内容读取出来。
       搜索原理：

* 内容爬取，停顿词过滤比如像一些无用的  “的”  “了”之类的语气词/连接词

* 内容分词，提取关键词

* 根据关键词建立倒排索引

* 用户输入关键词进行搜索

  

#### 2.3.3.1 倒排索引

索引类似于目录，通过主键定位到某条数据；而倒排索引刚好相反，数据对应到主键。
倒排索引建立过程：
数据： "你好"   "你爸"  "你妈" 

| id   | word | index |
| ---- | ---- | ----- |
| 1    | 你   | 1     |
| 2    | 你   | 2     |
| 3    | 你   | 3     |
| 4    | 好   | 1     |
| 5    | 妈   | 2     |
| 6    | 爸   | 3     |


去重 ------

| id   | word | index |
| ---- | ---- | ----- |
| 1    | 你   | 1,2,3 |
| 4    | 好   | 1     |
| 5    | 妈   | 2     |
| 6    | 爸   | 3     |

排序：

| id   | word | index |
| ---- | ---- | ----- |
| 1    | 爸   | 3     |
| 2    | 好   | 1     |
| 3    | 妈   | 2     |
| 4    | 你   | 1,2,3 |



#### 2.3.3.2 正排索引

通过ID找到这条记录...



# 四 分词器

## 4.1 概述

* 分词器的作用就像它的命名一样，能够一段文字拆分成多个词，比如："清华大学"，如果拆分为"清","华","大","学"，那这种分词就失去了词汇的意义了。这里如果涉及中文分词的场景，建议使用ik分词器。

## 4.2 分词器组成：

​	分词器是专门处理分词的组件，分词器由以下三部分组成：

- **Character Filters**：针对原始文本处理，比如去除 html 标签

- **Tokenizer**：按照规则切分为单词，比如按照空格切分

- **Token Filters**：将切分的单词进行加工，比如大写转小写，删除 stopwords，增加同义语

同时 Analyzer 三个部分也是有顺序的，从上到下依次经过 `Character Filters`，`Tokenizer` 以及 `Token Filters`，这个顺序比较好理解，一个文本进来肯定要先对文本数据进行处理，再去分词，最后对分词的结果进行过滤。

其中，ES 内置了许多分词器：

- **Standard Analyzer** - 默认分词器，按词切分，小写处理
- **Simple Analyzer** - 按照非字母切分（符号被过滤），小写处理
- **Stop Analyzer** - 小写处理，停用词过滤（the ，a，is）
- **Whitespace Analyzer** - 按照空格切分，不转小写
- **Keyword Analyzer** - 不分词，直接将输入当做输出
- **Pattern Analyzer** - 正则表达式，默认 \W+
- **Language** - 提供了 30 多种常见语言的分词器
- **Customer Analyzer** - 自定义分词器

# 常见Q

1. es运行不能使用root
2. es强依赖jdk问题【r: 修改es配置，绑定对应的jdk】
3. 内存不足问题【默认2g，修改es配置】
4. max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]【r：elasticsearch`用户拥有的内存权限太小，至少需要`262144------ sysctl -w vm.max_map_count=262144】
5. 二次启动报：not all primary shards of [.geoip_databases] index are active【因为他启动时会去更新地图的一些数据库， 配置文件增加：ingest.geoip.downloader.enabled: false】
